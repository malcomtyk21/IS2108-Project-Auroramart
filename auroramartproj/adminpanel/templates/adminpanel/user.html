{% extends 'adminpanel/base_admin.html' %}
{% load static %}

{% block title %}Users - AuroraMart Admin{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />

<style>
    .status {
        padding: 4px 10px;
        border-radius: 12px;
        font-weight: 600;
    }

    .status.active {
        color:#047857;            
        background:#ecfdf5;  
        border-color:#a7f3d0;
    }

    .status.inactive {
        color:#b91c1c;           
        background:#fef2f2;       
        border-color:#fecaca;
    }
</style>
{% endblock %}

{% block navbar %}
{% include 'adminpanel/navbar.html' %}
{% endblock %}

{% block main_content %}

    <div class="header-container">
        <div class="header">
            <div class="header-left">
                <h1>User Management</h1>
                <p style="padding-bottom: 5px;">{% if page_obj %}{{ page_obj.paginator.count }}{% else %}{{ users|length }}{% endif %} Users found</p>
            </div>
            <div class="header-right">
                <button class="btn-add"><a style="color: white" href="{% url 'user_customer_add' %}">Create Customer</a></button>
                {% if request.user.is_superuser %}
                <button class="btn-add"><a style="color: white" href="{% url 'user_admin_add' %}">Create Admin</a></button>
                {% endif %}
            </div>
        </div>

        {% if messages %}
            {% for message in messages %}
                {# Only trigger popup for messages tagged with user-update-popup #}
                {% if 'user-update-popup' in message.tags %}
                <script>alert("{{ message|escapejs }}");</script>
                {% endif %}
            {% endfor %}
        {% endif %}
        
        <form method="GET" id="page-size-form" class="filter-section">
            <div class="filter-first-row">
                <div class="filter-left">
                    <input type="text" name="search" placeholder="Search users..." value="{{ request.GET.search }}">

                    <button type="submit"><img width="14" height="14" src="https://img.icons8.com/?size=100&id=7eX13e1GI7bn&format=png&color=000000" alt="search"/> Search</button>
                </div>
                <div class="filter-right">
                    <label for="page_size"> Show:</label>
                    <select name="page_size" id="page_size" onchange="document.getElementById('page-size-form').submit();">
                        <option value="5" {% if request.GET.page_size == "5" %}selected{% endif %}>5</option>
                        <option value="10" {% if request.GET.page_size == "10" or not request.GET.page_size %}selected{% endif %}>10
                        </option>
                        <option value="25" {% if request.GET.page_size == "25" %}selected{% endif %}>25</option>
                        <option value="50" {% if request.GET.page_size == "50" %}selected{% endif %}>50</option>
                    </select>
                    entries per page
                </div>
            </div>
        
            <div class="filter-second-row">
                <div class="date-range">
                    <label>Joined:</label>
                    <input type="date" name="joined_from" value="{{ joined_from }}">
                    <label>to</label>
                    <input type="date" name="joined_to" value="{{ joined_to }}">
                </div>
                <div class="date-range">
                    <label>Last Login:</label>
                    <input type="date" name="login_from" value="{{ login_from }}">
                    <label>to</label>
                    <input type="date" name="login_to" value="{{ login_to }}">
                </div>
                <button type="submit">Apply Filters</button>
                <a href="?{% if request.GET.page_size %}page_size={{ request.GET.page_size }}{% endif %}">
                <button type="button">Clear All</button></a>
            </div>
            <p id="price-error" class="error-message" style="color: red; font-size: 14px; padding-top: 10px;"></p>
        </form>
    </div>

<div class="container">
    <div class="inner-nav">
        <a href="{% url 'user' %}" class="nav-tab {% if selected_tab == 'all' %}active{% endif %}">All ({{ counts.all }})</a>
        <a href="{% url 'user_admin' %}" class="nav-tab {% if selected_tab == 'admin' %}active{% endif %}">Admin ({{ counts.admin }})</a>
        <a href="{% url 'user_customer' %}" class="nav-tab {% if selected_tab == 'customer' %}active{% endif %}">Customer ({{ counts.customer }})</a>
    </div>
    <div class="table-container">
        <table width="100%">
            <thead>
                <tr>
                    <th>Username
                        <a
                            href="?{{ request.GET.urlencode|default:'' }}&sort=username&dir={% if request.GET.dir == 'asc' %}desc{% else %}asc{% endif %}">
                            {% if request.GET.sort == 'username' %}
                            {% if request.GET.dir == 'asc' %} <img width="10" height="10"
                                src="https://img.icons8.com/ios-glyphs/30/sort-up.png" alt="sort-up" /> {% else %} <img width="10"
                                height="10" src="https://img.icons8.com/fluency-systems-filled/48/sort-down.png" alt="sort-down" /> {% endif %}
                            {% else %} <img width="10" height="10" src="https://img.icons8.com/ios-filled/50/generic-sorting.png"
                                alt="generic-sorting" />
                            {% endif %}
                        </a>
                    </th>
                    <th>First Name
                        <a
                            href="?{{ request.GET.urlencode|default:'' }}&sort=first_name&dir={% if request.GET.dir == 'asc' %}desc{% else %}asc{% endif %}">
                            {% if request.GET.sort == 'first_name' %}
                            {% if request.GET.dir == 'asc' %} <img width="10" height="10"
                                src="https://img.icons8.com/ios-glyphs/30/sort-up.png" alt="sort-up" /> {% else %} <img width="10"
                                height="10" src="https://img.icons8.com/fluency-systems-filled/48/sort-down.png" alt="sort-down" /> {% endif %}
                            {% else %} <img width="10" height="10" src="https://img.icons8.com/ios-filled/50/generic-sorting.png"
                                alt="generic-sorting" />
                            {% endif %}
                        </a>
                    </th>
                    <th>Last Name
                        <a
                            href="?{{ request.GET.urlencode|default:'' }}&sort=last_name&dir={% if request.GET.dir == 'asc' %}desc{% else %}asc{% endif %}">
                            {% if request.GET.sort == 'last_name' %}
                            {% if request.GET.dir == 'asc' %} <img width="10" height="10"
                                src="https://img.icons8.com/ios-glyphs/30/sort-up.png" alt="sort-up" /> {% else %} <img width="10"
                                height="10" src="https://img.icons8.com/fluency-systems-filled/48/sort-down.png" alt="sort-down" /> {% endif %}
                            {% else %} <img width="10" height="10" src="https://img.icons8.com/ios-filled/50/generic-sorting.png"
                                alt="generic-sorting" />
                            {% endif %}
                        </a>
                    </th>
                    <th>Email
                        <a
                            href="?{{ request.GET.urlencode|default:'' }}&sort=email&dir={% if request.GET.dir == 'asc' %}desc{% else %}asc{% endif %}">
                            {% if request.GET.sort == 'email' %}
                            {% if request.GET.dir == 'asc' %} <img width="10" height="10"
                                src="https://img.icons8.com/ios-glyphs/30/sort-up.png" alt="sort-up" /> {% else %} <img width="10"
                                height="10" src="https://img.icons8.com/fluency-systems-filled/48/sort-down.png" alt="sort-down" /> {% endif %}
                            {% else %} <img width="10" height="10" src="https://img.icons8.com/ios-filled/50/generic-sorting.png"
                                alt="generic-sorting" />
                            {% endif %}
                        </a>
                    </th>
                    <th>Date Joined
                        <a href="?{{ request.GET.urlencode|default:'' }}&sort=date_joined&dir={% if request.GET.dir == 'asc' %}desc{% else %}asc{% endif %}">
                            {% if request.GET.sort == 'date_joined' %}
                            {% if request.GET.dir == 'asc' %} <img width="10" height="10"
                                src="https://img.icons8.com/ios-glyphs/30/sort-up.png" alt="sort-up" /> {% else %} <img width="10"
                                height="10" src="https://img.icons8.com/fluency-systems-filled/48/sort-down.png" alt="sort-down" /> {% endif %}
                            {% else %} <img width="10" height="10" src="https://img.icons8.com/ios-filled/50/generic-sorting.png"
                                alt="generic-sorting" />
                            {% endif %}</a>
                    </th>
                    <th>Last Logged In</th>
                    <th>Status
                        <a
                            href="?{{ request.GET.urlencode|default:'' }}&sort=status&dir={% if request.GET.dir == 'asc' %}desc{% else %}asc{% endif %}">
                            {% if request.GET.sort == 'status' %}
                            {% if request.GET.dir == 'asc' %} <img width="10" height="10"
                                src="https://img.icons8.com/ios-glyphs/30/sort-up.png" alt="sort-up" /> {% else %} <img width="10"
                                height="10" src="https://img.icons8.com/fluency-systems-filled/48/sort-down.png" alt="sort-down" /> {% endif %}
                            {% else %} <img width="10" height="10" src="https://img.icons8.com/ios-filled/50/generic-sorting.png"
                                alt="generic-sorting" />
                            {% endif %}
                        </a>
                    </th>
                    <th>Role</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for user in users %}
                <tr>
                    <td>{{ user.username }}</td>
                    <td>{{ user.first_name }}</td>
                    <td>{{ user.last_name }}</td>
                    <td>{{ user.email }}</td>
                    <td>{{ user.date_joined }}</td>
                    <td>{{ user.last_login }}</td>
                    <td>

                    <span class="status {% if user.is_active %}active{% else %}inactive{% endif %}">{% if user.is_active %}Active{% else %}Inactive{% endif %}</span>
                    </td>
                    <td>{% if user.is_superuser %}Superadmin{% elif user.is_staff %}Admin{% else %}Customer{% endif %}</td>
                    <td style="white-space:nowrap;">
                        {% if request.user.is_staff or request.user.is_superuser %}
                            {% if not user.is_staff and not user.is_superuser and user.is_active%}
                                <button class="btn-add"><a href="{% url 'user_customer_orders' user.pk %}" title="View Orders"><span class="material-symbols-outlined">assignment</span></a></button>
                            {% endif %}
                        {% endif %}
                        {% if request.user.is_superuser %}
                        {% if not user.is_superuser or user.pk != request.user.pk %}
                        <button class="btn-add"><a href="{% url 'user_edit' user.pk %}" title="Edit"><span class="material-symbols-outlined">edit</span></a></button>
                        {% endif %}
                        {% elif request.user.is_staff and not request.user.is_superuser %}
                        {% if not user.is_staff and not user.is_superuser %}
                        <button class="btn-add"><a href="{% url 'user_edit' user.pk %}" title="Edit"><span class="material-symbols-outlined">edit</span></a></button>
                        {% endif %}
                        {% endif %}
        
                        {% if request.user.is_superuser and user.pk != request.user.pk %}
                        <form action="{% url 'user_delete' user.pk %}" method="post" style="display:inline"
                            onsubmit="return confirm('Delete {{ user.username }}?');">
                            {% csrf_token %}
                            <button class="btn-add" type="submit">
                                <span class="material-symbols-outlined">delete</span>
                            </button>
                        </form>
                        {% elif request.user.is_staff and not request.user.is_superuser %}
                        {% if not user.is_staff and not user.is_superuser %}
                        <form action="{% url 'user_delete' user.pk %}" method="post" style="display:inline"
                            onsubmit="return confirm('Delete {{ user.username }}?');">
                            {% csrf_token %}
                            <button class="btn-add" type="submit">
                                <span class="material-symbols-outlined">delete</span>
                            </button>
                        </form>
                        {% endif %}
                        {% endif %}
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="9">No users found.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    {% if is_paginated %}
    <div class="pager">
        <div class="pagination-left">
                Showing {{ page_obj.start_index }} to {{ page_obj.end_index }} of {{ page_obj.paginator.count }} entries
            </div>
        <div class="pagination-right">
        {% if page_obj.has_previous %}
        <a class="pager-arrow" href="?{{ request.GET.urlencode|default:'' }}&page={{ page_obj.previous_page_number }}">&lt;</a>
        {% else %}
        <span class="pager-arrow disabled">&lt;</span>
        {% endif %}

        {% for item in compact_page_range %}
            {% if item == '...' %}
                <span class="pager-ellipsis">...</span>
            {% else %}
                {% if item == page_obj.number %}
                    <span class="pager-page active">{{ item }}</span>
                {% else %}
                    <a class="pager-page" href="?{{ request.GET.urlencode|default:'' }}&page={{ item }}">{{ item }}</a>
                {% endif %}
            {% endif %}
        {% endfor %}

        {% if page_obj.has_next %}
        <a class="pager-arrow" href="?{{ request.GET.urlencode|default:'' }}&page={{ page_obj.next_page_number }}">&gt;</a>
        {% else %}
        <span class="pager-arrow disabled">&gt;</span>
        {% endif %}
        
    </div>
    {% endif %}
        </div>
</div>
{% endblock %}