{% extends 'onlinestorefront/base_store.html' %}
{% load static %}
{% load crispy_forms_tags %}

{% block title %}Settings | AuroraMart{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'onlinestorefront/css/settings.css' %}">
{% endblock %}

{% block content %}
<div class="container py-4">
  <div class="row g-4">
    <aside class="col-12 col-md-3">
      <nav class="settings-nav card p-2">
        <a class="settings-link {% if active_tab == 'account' %}active{% endif %}" href="{% url 'onlinestorefront:settings' %}?tab=account">Account Particulars</a>
        <a class="settings-link {% if active_tab == 'profile' %}active{% endif %}" href="{% url 'onlinestorefront:settings' %}?tab=profile">Customer Profile</a>
        <a class="settings-link {% if active_tab == 'shipping' %}active{% endif %}" href="{% url 'onlinestorefront:settings' %}?tab=shipping">Saved Addresses</a>
        <a class="settings-link {% if active_tab == 'payments' %}active{% endif %}" href="{% url 'onlinestorefront:settings' %}?tab=payments">Payment Methods</a>
        <a class="settings-link {% if active_tab == 'password' %}active{% endif %}" href="{% url 'onlinestorefront:settings' %}?tab=password">Change Password</a>
      </nav>
    </aside>

    <section class="col-12 col-md-9">
      <h1 class="h4 mb-3">Settings</h1>

      {% if messages %}
        {% for message in messages %}
        <div class="alert alert-{{ message.tags|default:'warning' }} alert-dismissible fade show" role="alert">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        {% endfor %}
      {% endif %}

      {# PROFILE TAB #}
      {% if active_tab == 'profile' %}
      <div class="card p-3">
        <h2 class="h5">Customer Profile</h2>
        <form method="post">
          {% csrf_token %}
          <input type="hidden" name="tab" value="profile">
          <div class="row g-3">
            {{ profile_form|crispy }}
          </div>
          <button type="submit" class="store-btn mt-2">Save Changes</button>
        </form>
        <div class="mt-3 small text-muted">
          {% if preferred_category %}
            Predicted preferred category: <strong>{{ preferred_category }}</strong>
          {% else %}
            Fill your details and save to get a category recommendation.
          {% endif %}
        </div>
      </div>
      {% endif %}

      {# PAYMENTS TAB #}
      {% if active_tab == 'payments' %}
      <div class="card p-3 mb-4">
        <h2 class="h5">Saved Payment Methods</h2>
        {% if payment_pairs %}
          <div class="saved-list">
            {% for pair in payment_pairs %}
              {% with p=pair.obj pform=pair.form %}
              <div class="saved-card">
                <div class="d-flex justify-content-between align-items-start">
                  <div>
                    <div class="saved-title">{{ p.card_brand }} •••• {{ p.card_last4 }}</div>
                    <div class="saved-meta">Exp {{ p.expiry_month }}/{{ p.expiry_year }} • {{ p.cardholder_name }}</div>
                    {% if p.billing_address %}
                    <div class="saved-address">{{ p.billing_address }}</div>
                    {% endif %}
                  </div>
                  <div class="ms-3 d-flex gap-2">
                    <button class="store-icon-btn store-icon-btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#pay-edit-{{ p.id }}" aria-expanded="{% if pform.errors %}true{% else %}false{% endif %}" aria-controls="pay-edit-{{ p.id }}" aria-label="Edit payment"><span class="material-icons">edit</span></button>
                    <form method="post">
                      {% csrf_token %}
                      <input type="hidden" name="tab" value="payments">
                      <input type="hidden" name="action" value="delete">
                      <input type="hidden" name="payment_id" value="{{ p.id }}">
                      <button type="submit" class="store-icon-btn store-icon-btn-sm store-icon-btn--danger" aria-label="Delete payment"><span class="material-icons">delete</span></button>
                    </form>
                  </div>
                </div>
                <div class="collapse mt-3 {% if pform.errors %}show{% endif %}" id="pay-edit-{{ p.id }}">
                  <form method="post">
                    {% csrf_token %}
                    <input type="hidden" name="tab" value="payments">
                    <input type="hidden" name="action" value="edit">
                    <input type="hidden" name="payment_id" value="{{ p.id }}">
                    <div class="row g-3">
                      <div class="col-12">
                        {{ pform.card_brand|as_crispy_field }}
                      </div>
                      <div class="col-12">
                        {{ pform.card_number|as_crispy_field }}
                      </div>
                      <div class="col-12">
                        {{ pform.cardholder_name|as_crispy_field }}
                      </div>

                      <div class="col-12 row gx-4 gy-2 align-items-center">
                        <div class="col-4 col-md-2">
                          {{ pform.expiry_month|as_crispy_field }}
                        </div>
                        <div class="col-4 col-md-2">
                          {{ pform.expiry_year|as_crispy_field }}
                        </div>
                      </div>

                      <div class="col-12">
                        {{ pform.billing_address|as_crispy_field }}
                      </div>
                    </div>
                    <button type="submit" class="store-btn store-btn-sm mt-2">Save Changes</button>
                  </form>
                </div>
              </div>
              {% endwith %}
            {% endfor %}
          </div>
        {% else %}
          <p class="text-muted">You have no saved payment methods yet.</p>
        {% endif %}
      </div>

      <div class="card p-3">
        <h3 class="h6">Add New Payment Method</h3>
        <form method="post">
          {% csrf_token %}
          <input type="hidden" name="tab" value="payments">
          <div class="row g-3">
            <div class="col-12">
              {{ payment_form.card_brand|as_crispy_field }}
            </div>
            <div class="col-12">
              {{ payment_form.card_number|as_crispy_field }}
            </div>
            <div class="col-12">
              {{ payment_form.cardholder_name|as_crispy_field }}
            </div>

            <div class="col-12 row gx-4 gy-2 align-items-center">
              <div class="col-4 col-md-2">
                {{ payment_form.expiry_month|as_crispy_field }}
              </div>
              <div class="col-4 col-md-2">
                {{ payment_form.expiry_year|as_crispy_field }}
              </div>
            </div>

            <div class="col-12">
              {{ payment_form.billing_address|as_crispy_field }}
            </div>
          </div>
          <button type="submit" class="store-btn mt-2">Save Payment Method</button>
        </form>
      </div>
      {% endif %}

      {# SHIPPING TAB #}
      {% if active_tab == 'shipping' %}
      <div class="card p-3 mb-4">
        <h2 class="h5">Saved Shipping Addresses</h2>
        {% if shipping_pairs %}
          <div class="saved-list">
            {% for pair in shipping_pairs %}
              {% with s=pair.obj sform=pair.form %}
              <div class="saved-card">
                <div class="d-flex justify-content-between align-items-start">
                  <div>
                    <div class="saved-title">{{ s.address_line1 }}</div>
                    {% if s.address_line2 %}<div>{{ s.address_line2 }}</div>{% endif %}
                    <div class="saved-meta">{{ s.city }}, {{ s.state }} {{ s.postal_code }} • {{ s.country }}</div>
                    <div class="saved-meta">Contact: {{ s.contact_number }}</div>
                  </div>
                  <div class="ms-3 d-flex gap-2">
                    <button class="store-icon-btn store-icon-btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#ship-edit-{{ s.id }}" aria-expanded="{% if sform.errors %}true{% else %}false{% endif %}" aria-controls="ship-edit-{{ s.id }}" aria-label="Edit address"><span class="material-icons">edit</span></button>
                    <form method="post">
                      {% csrf_token %}
                      <input type="hidden" name="tab" value="shipping">
                      <input type="hidden" name="action" value="delete">
                      <input type="hidden" name="shipping_id" value="{{ s.id }}">
                      <button type="submit" class="store-icon-btn store-icon-btn-sm store-icon-btn--danger" aria-label="Delete address"><span class="material-icons">delete</span></button>
                    </form>
                  </div>
                </div>
                <div class="collapse mt-3 {% if sform.errors %}show{% endif %}" id="ship-edit-{{ s.id }}">
                  <form method="post">
                    {% csrf_token %}
                    <input type="hidden" name="tab" value="shipping">
                    <input type="hidden" name="action" value="edit">
                    <input type="hidden" name="shipping_id" value="{{ s.id }}">
                    {{ sform|crispy }}
                    <button type="submit" class="store-btn store-btn-sm mt-2">Save Changes</button>
                  </form>
                </div>
              </div>
              {% endwith %}
            {% endfor %}
          </div>
        {% else %}
          <p class="text-muted">You have no saved addresses yet.</p>
        {% endif %}
      </div>

      <div class="card p-3">
        <h3 class="h6">Add New Shipping Address</h3>
        <form method="post">
          {% csrf_token %}
          <input type="hidden" name="tab" value="shipping">
          <div class="row g-3">
            {{ shipping_form|crispy }}
          </div>
          <button type="submit" class="store-btn mt-2">Save Address</button>
        </form>
      </div>
      {% endif %}

        {# ACCOUNT PARTICULARS TAB #}
        {% if active_tab == 'account' %}
        <div class="card p-3 mb-4">
          <h2 class="h5">Account Particulars</h2>
          <form method="post">
            {% csrf_token %}
            <input type="hidden" name="tab" value="account">
            <div class="row g-3">
              {{ account_form|crispy }}
            </div>
            <button type="submit" class="store-btn mt-2">Save Changes</button>
          </form>
        </div>
        {% endif %}

        {# PASSWORD CHANGE TAB #}
        {% if active_tab == 'password' %}
        {% if messages %}
          {% for message in messages %}
          <div class="alert alert-{{ message.tags|default:'warning' }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
          {% endfor %}
        {% endif %}
        <div class="card p-3 mb-4">
          <h2 class="h5">Change Password</h2>
          <form method="post">
            {% csrf_token %}
            <input type="hidden" name="tab" value="password">
            <div class="row g-3">
              {{ password_form|crispy }}
            </div>
            <button type="submit" class="store-btn mt-2">Change Password</button>
          </form>
        </div>
        {% endif %}
    </section>
  </div>
</div>
{% endblock %}
