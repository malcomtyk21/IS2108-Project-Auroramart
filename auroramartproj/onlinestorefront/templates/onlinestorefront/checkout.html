{% extends 'onlinestorefront/base_store.html' %}
{% load static %}
{% block extra_head %}
<link rel="stylesheet" href="{% static 'onlinestorefront/css/checkout.css' %}">
{% endblock %}
{% block title %}Checkout | AuroraMart{% endblock %}
{% block content %}
<div class="container py-4 py-md-5">
    <div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="h4 mb-0">Checkout</h1>
    <a href="{% url 'onlinestorefront:cart' %}" class="store-btn store-btn-sm">Back to Cart</a>
  </div>

  {% if items %}
  <div class="row g-4">
    <div class="col-12 col-lg-7">
      <div class="card shadow-sm">
        <div class="card-header bg-white">
          <strong>Order Summary ({{ item_count }} items)</strong>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table align-middle mb-0">
              <thead>
                <tr>
                  <th scope="col">Product</th>
                  <th scope="col" class="text-end">Qty</th>
                  <th scope="col" class="text-end">Unit</th>
                  <th scope="col" class="text-end">Total</th>
                </tr>
              </thead>
              <tbody>
                {% for line in items %}
                <tr>
                  <td>
                    <div class="fw-semibold">{{ line.product.product_name }}</div>
                    <div class="text-muted small">{{ line.product.product_category }}{% if line.product.product_subcategory %} • {{ line.product.product_subcategory }}{% endif %}</div>
                  </td>
                  <td class="text-end">{{ line.qty }}</td>
                  <td class="text-end">${{ line.price|floatformat:2 }}</td>
                  <td class="text-end">${{ line.line_total|floatformat:2 }}</td>
                </tr>
                {% endfor %}
              </tbody>
              <tfoot>
                <tr>
                  <th colspan="3" class="text-end">Subtotal</th>
                  <th class="text-end">${{ subtotal|floatformat:2 }}</th>
                </tr>
              </tfoot>
            </table>
          </div>
        </div>
      </div>
    </div>

    <div class="col-12 col-lg-5">
      <div class="vstack gap-4">
        <form id="checkout-form" method="post" class="vstack gap-4">
          {% csrf_token %}
          {# Preserve the originally selected cart items across postbacks #}
          {% if selected_ids %}
            {% for sid in selected_ids %}
              <input type="hidden" name="selected_items" value="{{ sid }}">
            {% endfor %}
          {% endif %}
          <!-- Shipping Selection -->
          <div class="card shadow-sm">
            <div class="card-header bg-white"><strong>Shipping Address</strong></div>
            <div class="card-body">
              {% if shippings %}
                {% for s in shippings %}
                <div class="form-check mb-2">
                  <input class="form-check-input" type="radio" name="shipping_id" id="ship-{{ s.id }}" value="{{ s.id }}" {% if selected_shipping and selected_shipping.id == s.id %}checked{% elif not selected_shipping and forloop.first %}checked{% endif %}>
                  <label class="form-check-label" for="ship-{{ s.id }}">
                    <div class="fw-semibold">{{ s.address_line1 }}</div>
                    <div class="text-muted small">{% if s.address_line2 %}{{ s.address_line2 }}, {% endif %}{{ s.city }}, {{ s.state }} {{ s.postal_code }}, {{ s.country }}</div>
                    <div class="text-muted small">Contact: {{ s.contact_number }}</div>
                  </label>
                </div>
                {% endfor %}
              {% else %}
              <p class="text-muted mb-0">No saved addresses. <a href="{% url 'onlinestorefront:settings' %}?tab=shipping">Add one</a>.</p>
              {% endif %}
            </div>
          </div>

          <!-- Payment Selection -->
          <div class="card shadow-sm">
            <div class="card-header bg-white"><strong>Payment Method</strong></div>
            <div class="card-body">
              {% if payments %}
                {% for p in payments %}
                <div class="form-check mb-2">
                  <input class="form-check-input" type="radio" name="payment_id" id="pay-{{ p.id }}" value="{{ p.id }}" {% if selected_payment and selected_payment.id == p.id %}checked{% elif not selected_payment and forloop.first %}checked{% endif %}>
                  <label class="form-check-label" for="pay-{{ p.id }}">
                    <div class="fw-semibold">{{ p.card_brand }} •••• {{ p.card_last4 }}</div>
                    <div class="text-muted small">Exp {{ p.expiry_month }}/{{ p.expiry_year }} • {{ p.cardholder_name }}</div>
                    <div class="text-muted small">Billing: {{ p.billing_address|truncatechars:80 }}</div>
                  </label>
                </div>
                {% endfor %}
              {% else %}
              <p class="text-muted mb-0">No saved payment methods. <a href="{% url 'onlinestorefront:settings' %}?tab=payments">Add one</a>.</p>
              {% endif %}
            </div>
          </div>

          <!-- Submit (future order placement) -->
          <div class="card border-0">
            <div class="card-body d-grid gap-2">
              {% if error %}
                <div class="alert alert-danger p-2 mb-0 small">{{ error }}</div>
              {% endif %}
              <div class="d-flex gap-2">
                <button type="submit" class="store-btn w-100" name="place_order" value="1">Place Order</button>
              </div>
              {% if selected_payment and selected_shipping %}
                <div class="alert alert-secondary p-2 mb-0 small">Payment {{ selected_payment.card_brand }} •••• {{ selected_payment.card_last4 }} and shipping to {{ selected_shipping.city }} selected.</div>
              {% else %}
                <small class="text-muted">Select a shipping address and payment method above.</small>
              {% endif %}
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>
  {% else %}
  <p>Your cart selection is empty.</p>
  <a href="{% url 'onlinestorefront:cart' %}" class="btn btn-outline-secondary">Back to Cart</a>
  {% endif %}

</div>
<script>
document.addEventListener('DOMContentLoaded', function () {
  var form = document.getElementById('checkout-form');
  if (!form) return;

  function submitAsReview() {
    var existing = form.querySelector('input[name="review"]');
    if (!existing) {
      existing = document.createElement('input');
      existing.type = 'hidden';
      existing.name = 'review';
      existing.value = '1';
      form.appendChild(existing);
    } else {
      existing.value = '1';
    }
    form.submit();
  }

  var selectors = form.querySelectorAll('input[name="shipping_id"], input[name="payment_id"]');
  selectors.forEach(function (el) {
    el.addEventListener('change', submitAsReview);
  });
});
</script>
{% endblock %}
